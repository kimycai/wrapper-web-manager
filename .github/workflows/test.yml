name: 'Build st0rmMusicPlayer (Final: No Any Errors)'
on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      FFMPEG_VERSION: 8.0
      NODE_VERSION: 18.x
      PYTHON_VERSION: 3.9
 

    steps:
      - name: Clone author's st0rmMusicPlayer (public repo)
        uses: actions/checkout@v4
        with:
          repository: sn0wst0rm/st0rmMusicPlayer
          ref: main
          submodules: recursive
          path: st0rmMusicPlayer
          token: ${{ secrets.GITHUB_TOKEN }}

      # 核心修复：Python 3.9 安装（重新实现pip3全局注册，解决command not found）
      - name: Install Python 3.9 (fix pip3 command not found)
        run: |
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt update -y
          # 安装Python3.9全套依赖（含基础运行、虚拟环境、开发库）
          sudo apt install -y --no-install-recommends python3.9 python3.9-venv python3.9-dev
          # 1. 强制安装并升级Python3.9专属pip（ensurepip+upgrade确保最新版）
          python3.9 -m ensurepip --upgrade --force
          # 2. 全局绑定python3命令到3.9版本（优先级100，确保默认调用）
          sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 100
          # 3. 关键修复：将Python3.9的pip3链接到系统全局bin目录（路径100%可靠）
          # 原理：python3.9 -m pip 是版本专属调用，软链接到/usr/bin实现全局识别
          sudo ln -sf "$(which python3.9)" -m pip /usr/bin/pip3
          # 4. 验证pip3是否生效（先检查命令存在，再输出版本）
          echo "=== Check pip3 command existence ==="
          which pip3
          echo "=== Python Global Version ==="
          python3 --version
          echo "=== Pip3 Global Version & Belonging ==="
          pip3 --version

      - name: Install FFmpeg 8.0 (prebuilt static, no compile)
        run: |
          mkdir -p ~/ffmpeg && cd ~/ffmpeg
          wget https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz -O ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz --strip-components=1
          sudo cp bin/ffmpeg bin/ffprobe /usr/local/bin/
          ffmpeg -version | head -n1
          ffprobe -version | head -n1
          rm -rf ~/ffmpeg

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: st0rmMusicPlayer/package-lock.json

      - name: Global environment version check (critical)
        run: |
          echo "=== Node.js & NPM Version ==="
          node -v && npm -v
          echo -e "\n=== Python & Pip3 Version ==="
          python3 --version && pip3 --version
          echo -e "\n=== FFmpeg & FFprobe Version ==="
          ffmpeg -version | head -n1
          ffprobe -version | head -n1

      - name: Run project setup script
        run: |
          cd st0rmMusicPlayer
          chmod +x ./setup.sh
          cp .env.example .env
          ./setup.sh

      - name: Build production bundle (Next.js)
        run: |
          cd st0rmMusicPlayer
          npm run build

      - name: Package build artifacts
        run: |
          mkdir -p ./st0rmMusicPlayer-build
          cp -r ./st0rmMusicPlayer/.next ./st0rmMusicPlayer/node_modules ./st0rmMusicPlayer/public ./st0rmMusicPlayer/prisma ./st0rmMusicPlayer/scripts ./st0rmMusicPlayer/package.json ./st0rmMusicPlayer/package-lock.json ./st0rmMusicPlayer/.env ./st0rmMusicPlayer/setup.sh ./st0rmMusicPlayer-build/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: st0rmMusicPlayer-ffmpeg8.0-python3.9-node18
          path: ./st0rmMusicPlayer-build
          retention-days: 30
