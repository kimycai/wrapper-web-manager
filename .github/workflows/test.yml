name: st0rmMusic 完整自动化构建（含FFmpeg+所有依赖）
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # 手动触发（优先推荐调试）

jobs:
  build-st0rm-music:
    runs-on: ubuntu-latest # 适配FFmpeg Linux64包，脚本原生兼容
    steps:
      # 步骤1：拉取仓库（含子模块，st0rmMusic核心依赖，必配）
      - name: 拉取st0rmMusicPlayer仓库（含子模块）
        uses: actions/checkout@v4
        with:
          repository: sn0wst0rm/st0rmMusicPlayer
          ref: main
          submodules: recursive
          path: st0rmMusicPlayer
          token: ${{ secrets.GITHUB_TOKEN }}

      # 步骤2：下载并配置FFmpeg（核心新增，从指定地址获取静态包）
      - name: 安装FFmpeg（从BtbN/FFmpeg-Builds下载）
        run: |
          # 定义FFmpeg下载地址（与需求完全一致）
          FFMPEG_URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz"
          # 下载FFmpeg包（-q 静默下载，-O 重命名为ffmpeg.tar.xz）
          curl -q -L -O $FFMPEG_URL
          # 解压到/opt/ffmpeg（系统级目录，方便全局调用）
          sudo mkdir -p /opt/ffmpeg
          sudo tar -xJf ffmpeg.tar.xz -C /opt/ffmpeg --strip-components=1
          # 将FFmpeg可执行目录添加到系统PATH（全局可调用ffmpeg/ffprobe）
          echo "/opt/ffmpeg/bin" >> $GITHUB_PATH
          # 验证FFmpeg安装（输出版本，确认可用）
          ffmpeg -version
          ffprobe -version

      # 步骤3：配置Node.js 20.19.0（适配Prisma，解决此前版本兼容问题）
      - name: 配置Node.js 20.19.0
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: st0rmMusicPlayer/package-lock.json

      # 步骤4：配置Python 3.9（匹配setup.sh脚本强制要求）
      - name: 配置Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # 步骤5：安装Ubuntu系统依赖（setup.sh必选python3-venv）
      - name: 安装系统级依赖
        run: sudo apt update && sudo apt install -y python3-venv

      # 步骤6：赋予setup.sh执行权限（避免权限拒绝错误）
      - name: 赋予安装脚本执行权限
        run: chmod +x st0rmMusicPlayer/setup.sh

      # 步骤7：无交互执行setup.sh（echo ""模拟回车，跳过数据库路径交互）
      - name: 无交互执行安装脚本
        run: |
          cd st0rmMusicPlayer
          # 模拟用户回车，使用默认数据库路径，核心解决交互问题
          echo "" | bash ./setup.sh
        env:
          CI: true # 标记CI环境，避免脚本等待手动输入

      # 步骤8：修复缺失依赖@tailwindcss/postcss（解决Next.js CSS编译报错）
      - name: 安装缺失的Tailwind PostCSS依赖
        run: |
          cd st0rmMusicPlayer
          npm install @tailwindcss/postcss --save-dev

      # 步骤9：构建Next.js生产包（带--webpack参数，匹配项目原构建命令）
      - name: 构建Next.js生产产物
        run: |
          cd st0rmMusicPlayer
          npm run build --webpack

      # 步骤10：上传构建产物（含所有运行依赖，方便下载部署）
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: st0rmMusicPlayer-build-ubuntu-ffmpeg8.0
          path: |
            st0rmMusicPlayer/.next/
            st0rmMusicPlayer/scripts/venv/
            st0rmMusicPlayer/library.db
            st0rmMusicPlayer/.env
            st0rmMusicPlayer/node_modules/
            st0rmMusicPlayer/public/
            st0rmMusicPlayer/package.json
            st0rmMusicPlayer/package-lock.json
          retention-days: 14 # 产物保留14天，可按需调整
