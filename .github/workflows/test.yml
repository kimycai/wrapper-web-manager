name: st0rmMusic Setup & Build

# 触发条件：push到main分支、手动触发、PR到main分支
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发

# 作业定义
jobs:
  setup-and-build:
    # 支持多系统（Ubuntu优先，macOS可选）
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest] # 可移除macos-latest减少耗时

    steps:
      # 步骤1：拉取代码仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：设置Node.js环境（匹配setup.sh要求的18+）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # 最低要求18，也可设20（LTS）
          cache: 'npm' # 缓存npm依赖，加速构建

      # 步骤3：设置Python环境（匹配setup.sh要求的3.9+）
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9' # 最低要求3.9，也可设3.11（稳定版）
          cache: 'pip' # 缓存pip依赖

      # 步骤4：安装系统级依赖（仅Ubuntu需要）
      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y python3-venv # 满足setup.sh的python3-venv检查

      # 步骤5：赋予setup.sh执行权限
      - name: Make setup.sh executable
        run: chmod +x st0rmMusicPlayer/setup.sh

      # 步骤6：非交互式运行setup.sh（关键：跳过手动输入数据库路径）
      - name: Run setup script (non-interactive)
        run: |
          # 预设数据库路径，避免交互式输入（覆盖setup.sh的read逻辑）
          echo "DEFAULT_DB_PATH=${{ github.workspace }}/library.db" > .env.tmp
          export USER_DB_PATH="${{ github.workspace }}/library.db"
          
          # 运行setup.sh并输出详细日志
          cd st0rmMusicPlayer
          bash -x ./setup.sh
        env:
          # 强制非交互模式，避免脚本等待输入
          CI: true

      # 步骤7：上传构建产物（可选，用于部署/下载）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: st0rmMusic-build-${{ matrix.os }}
          path: |
            st0rmMusicPlayer/.next/ # Next.js构建产物
            st0rmMusicPlayer/scripts/venv/ # Python虚拟环境
            st0rmMusicPlayer/library.db # 生成的数据库文件
            st0rmMusicPlayer/.env # 生成的环境文件
          retention-days: 7 # 产物保留7天，可按需调整
