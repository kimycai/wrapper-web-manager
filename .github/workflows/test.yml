name: 'Build st0rmMusicPlayer (Final: 100% Stable No Interactive)'
on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      # 核心环境配置（Prisma兼容+全工具稳定版）
      NODE_VERSION: 20.19.0
      PYTHON_VERSION: 3.9
      FFMPEG_VERSION: 8.0
      # 关键新增：预配置数据库路径环境变量，跳过setup.sh交互式输入
      # 路径使用脚本默认值，与报错日志中一致，无需修改
      LIBRARY_DB_PATH: /home/runner/work/wrapper-web-manager/wrapper-web-manager/st0rmMusicPlayer/library.db

    steps:
      - name: Clone st0rmMusicPlayer repo
        uses: actions/checkout@v4
        with:
          repository: sn0wst0rm/st0rmMusicPlayer
          ref: main
          submodules: recursive
          path: st0rmMusicPlayer
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: st0rmMusicPlayer/package-lock.json

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up FFmpeg ${{ env.FFMPEG_VERSION }}
        uses: FedericoCarboni/setup-ffmpeg@v2
        with:
          ffmpeg-version: ${{ env.FFMPEG_VERSION }}

      - name: Verify all environments
        run: |
          echo "=== Node.js & NPM (Prisma Compatible) ==="
          node -v && npm -v
          echo -e "\n=== Python & Pip ==="
          python --version && pip --version
          echo -e "\n=== FFmpeg & FFprobe ==="
          ffmpeg -version | head -n1 && ffprobe -version | head -n1
          echo -e "\n=== Preconfigured Env Variables ==="
          echo "LIBRARY_DB_PATH: ${{ env.LIBRARY_DB_PATH }}"

      # 方案2：高兼容.env文件处理（无文件不存在错误）
      - name: Run project setup script (No Interactive)
        run: |
          cd st0rmMusicPlayer
          chmod +x ./setup.sh
          # 自动匹配.env示例文件，无则创建空文件
          if [ -f .env.example ]; then
            cp .env.example .env
            echo "✅ Copied .env.example to .env"
          elif [ -f .env.sample ]; then
            cp .env.sample .env
            echo "✅ Copied .env.sample to .env"
          elif [ -f .env.example.dist ]; then
            cp .env.example.dist .env
            echo "✅ Copied .env.example.dist to .env"
          else
            touch .env
            echo "⚠️  No env example file found, created empty .env file"
          fi
          # 关键：将预配置的数据库路径写入.env（确保脚本能读取到）
          echo "LIBRARY_DB_PATH=${{ env.LIBRARY_DB_PATH }}" >> .env
          # 执行脚本（已无交互式输入，自动执行）
          ./setup.sh

      - name: Generate Prisma Client (Pre-Build Optimization)
        run: |
          cd st0rmMusicPlayer
          npx prisma generate

      - name: Build production bundle (Next.js + Prisma)
        run: |
          cd st0rmMusicPlayer
          npm run build

      - name: Package build artifacts
        run: |
          mkdir -p ./st0rmMusicPlayer-build
          cp -r ./st0rmMusicPlayer/.next ./st0rmMusicPlayer/node_modules ./st0rmMusicPlayer/public ./st0rmMusicPlayer/prisma ./st0rmMusicPlayer/scripts ./st0rmMusicPlayer/package.json ./st0rmMusicPlayer/package-lock.json ./st0rmMusicPlayer/.env ./st0rmMusicPlayer/setup.sh ./st0rmMusicPlayer/library.db ./st0rmMusicPlayer-build/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: st0rmMusicPlayer-100-stable
          path: ./st0rmMusicPlayer-build
          retention-days: 30
