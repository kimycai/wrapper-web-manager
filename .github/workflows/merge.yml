name: Wrapper-Manager Build & Push to kimycai/wrapper-web-manager
on:
  workflow_dispatch: # 仅手动触发，无自动执行

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备，标识提交者）
      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：匿名克隆双公有仓库（无需Token，仅最新版本，合并为单步骤）
      - name: Clone Public Repos
        run: |
          git clone --depth 1 https://github.com/sky8282/wrapper-manager-v1.git
          git clone --depth 1 https://github.com/kimycai/wrapper-push.git

      # 步骤3：合并两个仓库到临时目录（平级合并，无嵌套）
      - name: Merge to Temp Build Directory
        run: |
          mkdir -p temp-build
          cp -rp wrapper-manager-v1/. temp-build/
          cp -rp wrapper-push/. temp-build/

      # 步骤4：安装Go 1.23.0稳定版（手动安装，版本精准适配Ubuntu24.04）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version

      # 步骤5：Go编译核心流程（严格按要求执行，生成可执行文件）
      - name: Go Build (Init → Tidy → Build)
        run: |
          cd temp-build
          go mod init wrapper-manager
          go mod tidy
          go build -o wrapper-manager .
          chmod +x ./wrapper-manager

      # 步骤6：克隆自有仓库（获取带.git/的本地Git副本，推送必备）
      - name: Clone Own Repo - kimycai/wrapper-web-manager
        run: |
          git clone --depth 1 https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git

      # 步骤7：清空自有仓库（保留根.git/）+ 复制产物 + 精准清理冗余.git/
      - name: Copy Artifacts to Own Repo (Protect Root .git/)
        run: |
          cd wrapper-web-manager
          # 核心：仅清空根目录非.git内容，保留仓库核心.git/（基础命令无兼容问题）
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..
          # 复制临时目录产物到自有仓库根目录（无嵌套）
          cp -rp temp-build/. wrapper-web-manager/
          # 关键修复：仅删除产物中【子目录】的.git/，绝对保留根目录.git/
          # -mindepth 2 限定仅处理二级及以下目录，避免误删根.git/
          find wrapper-web-manager/ -mindepth 2 -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true

      # 步骤8：免密推送到远程仓库（修复拉取命令，适配浅克隆，保护.git/）
      - name: Push to kimycai/wrapper-web-manager (Fix Git Operations)
        run: |
          cd wrapper-web-manager
          # 修复1：浅克隆场景简化拉取，直接拉取远程main分支（避免rebase冲突）
          git pull https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main --allow-unrelated-histories 2>/dev/null || true
          # 暂存所有变更（根目录产物，无嵌套）
          git add .
          # 提交变更（无变更时不报错，避免流程中断）
          git commit -m "Manual build: merge + compile wrapper-manager (Go1.23 | Ubuntu24.04)" || echo "No changes to commit"
          # 免密推送到main分支（直接推送，无嵌套）
          git push https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main
