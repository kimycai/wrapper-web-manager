name: Push temp-build to kimycai/wrapper-web-manager
on:
  workflow_dispatch: # 仅手动触发，无自动执行

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git身份（推送必备，标识提交者）
      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：匿名克隆双公有仓库（无需Token，仅最新版本）
      - name: Clone Public Repos
        run: |
          git clone --depth 1 https://github.com/sky8282/wrapper-manager-v1.git
          git clone --depth 1 https://github.com/kimycai/wrapper-push.git

      # 步骤3：合并到temp-build（产物最终生成目录，核心）
      - name: Merge to temp-build Directory
        run: |
          mkdir -p temp-build
          cp -rp wrapper-manager-v1/. temp-build/
          cp -rp wrapper-push/. temp-build/

      # 步骤4：安装Go 1.23.0（版本精准，适配Ubuntu24.04）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version

      # 步骤5：Go编译（产物落地temp-build，完整保留）
      - name: Go Build (Init → Tidy → Build)
        run: |
          cd temp-build
          go mod init wrapper-manager
          go mod tidy
          go build -o wrapper-manager .
          chmod +x ./wrapper-manager
          ls -lahp ./ # 验证产物：查看文件列表+可执行权限

      # 步骤6：克隆自有仓库（获取带.git的本地副本，推送唯一载体）
      - name: Clone Own Repo - kimycai/wrapper-web-manager
        run: |
          git clone https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git

      # 步骤7：核心：清空自有仓库+复制temp-build所有内容到根目录
      - name: Copy temp-build to Own Repo Root
        run: |
          cd wrapper-web-manager
          # 清空根目录所有非.git内容，保留Git仓库核心
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..
          # 直接复制temp-build根内容到自有仓库根目录，无任何嵌套
          cp -rp temp-build/. wrapper-web-manager/

      # 步骤8：极简推送（解决浅克隆冲突，确保推送成功）
      - name: Push to kimycai/wrapper-web-manager
        run: |
          cd wrapper-web-manager
          git add .
          git commit -m "Push temp-build: wrapper-manager build (Go1.23 | Ubuntu24.04)" || echo "No changes to commit"
          # 拉取远程最新代码并合并，自动解决冲突，适配所有场景
          git pull --rebase https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main --allow-unrelated-histories 2>/dev/null || true
          git push https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main
