name: Wrapper-Manager Build & Push to kimycai/wrapper-web-manager
on:
  workflow_dispatch: # 仅手动触发，无自动执行

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git身份（推送仓库必备，标识提交者）
      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：匿名克隆双公有仓库（无需Token，仅最新版本）
      - name: Clone Public Repos
        run: |
          git clone --depth 1 https://github.com/sky8282/wrapper-manager-v1.git
          git clone --depth 1 https://github.com/kimycai/wrapper-push.git

      # 步骤3：合并仓库到临时目录（平级合并，无嵌套）
      - name: Merge to Temp Build Directory
        run: |
          mkdir -p temp-build
          cp -rp wrapper-manager-v1/. temp-build/
          cp -rp wrapper-push/. temp-build/

      # 步骤4：安装Go 1.23.0（手动安装，版本精准）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version

      # 步骤5：Go编译核心流程（按要求执行，生成可执行文件）
      - name: Go Build (Init → Tidy → Build)
        run: |
          cd temp-build
          go mod init wrapper-manager
          go mod tidy
          go build -o wrapper-manager .
          chmod +x ./wrapper-manager

      # 步骤6：克隆自有仓库（获取本地Git副本，用于推送，核心步骤）
      - name: Clone Own Repo - kimycai/wrapper-web-manager
        run: |
          git clone --depth 1 https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git

      # 步骤7：清空自有仓库（保留.git/）+ 复制产物
      - name: Copy Artifacts to Own Repo
        run: |
          cd wrapper-web-manager
          # 基础命令清空，仅保留.git/，无兼容问题
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..
          cp -rp temp-build/. wrapper-web-manager/
          # 删除产物中可能的.git（避免子模块，不影响主仓库）
          rm -rf wrapper-web-manager/.git/ 2>/dev/null || true

      # 步骤8：免密推送到远程仓库（拉取最新代码，避免冲突）
      - name: Push to kimycai/wrapper-web-manager
        run: |
          cd wrapper-web-manager
          # 拉取远程最新代码，解决分支冲突（自动化推送必加）
          git pull --rebase https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main
          git add .
          # 提交（无变更时不报错，避免流程中断）
          git commit -m "Manual build: merge + compile wrapper-manager (Go1.23 | Ubuntu24.04)" || echo "No changes to commit"
          # 免密推送到main分支
          git push https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main
