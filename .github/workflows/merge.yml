name: Wrapper-Manager Build & Push to kimycai/wrapper-web-manager
on:
  workflow_dispatch: # 仅手动触发，无自动执行

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送必备，标识提交者）
      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：匿名克隆双公有仓库（无需Token，仅最新版本）
      - name: Clone Public Repos
        run: |
          git clone --depth 1 https://github.com/sky8282/wrapper-manager-v1.git
          git clone --depth 1 https://github.com/kimycai/wrapper-push.git

      # 步骤3：合并仓库到临时目录（平级合并，无嵌套）
      - name: Merge to Temp Build Directory
        run: |
          mkdir -p temp-build
          cp -rp wrapper-manager-v1/. temp-build/
          cp -rp wrapper-push/. temp-build/

      # 步骤4：安装Go 1.23.0稳定版（版本精准，适配Ubuntu24.04）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version

      # 步骤5：Go编译核心流程（按要求执行，生成可执行文件）
      - name: Go Build (Init → Tidy → Build)
        run: |
          cd temp-build
          go mod init wrapper-manager
          go mod tidy
          go build -o wrapper-manager .
          chmod +x ./wrapper-manager

      # 步骤6：克隆自有仓库（获取带.git/的本地副本，推送必备）
      - name: Clone Own Repo - kimycai/wrapper-web-manager
        run: |
          git clone --depth 1 https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git

      # 步骤7：清空自有仓库（保留根.git/）+ 复制产物 + 精准清理冗余.git/
      - name: Copy Artifacts to Own Repo (Protect Root .git/)
        run: |
          cd wrapper-web-manager
          # 仅清空根目录非.git内容，保留仓库核心.git/
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..
          # 复制产物到自有仓库根目录，无嵌套
          cp -rp temp-build/. wrapper-web-manager/
          # 仅删除子目录的冗余.git/，绝对保护根.git/
          find wrapper-web-manager/ -mindepth 2 -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true

      # 步骤8：推送到远程仓库（核心修复：拉取远程最新代码后再推送）
      - name: Push to kimycai/wrapper-web-manager (Fix Non-Fast-Forward)
        run: |
          cd wrapper-web-manager
          # 1. 暂存所有产物变更
          git add .
          # 2. 提交变更（无变更时不报错，避免流程中断）
          git commit -m "Manual build: merge + compile wrapper-manager (Go1.23 | Ubuntu24.04)" || echo "No changes to commit"
          # 3. 核心修复：拉取远程main分支最新代码并合并，适配浅克隆
          # --allow-unrelated-histories 解决浅克隆历史记录不一致问题
          git pull https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main --allow-unrelated-histories -X theirs
          # 4. 免密推送到远程main分支（此时本地已同步远程最新版本，无冲突）
          git push https://${{ secrets.WRAPPER_PUSH_TOKEN }}@github.com/kimycai/wrapper-web-manager.git main
